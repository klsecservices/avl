| **Vulnerability**           | CVE-2024-50379                                                                                   |
|-----------------------------|--------------------------------------------------------------------------------------------------|
| **Description**             | CVE-2024-50379 is a critical Time-of-Check Time-of-Use (TOCTOU) race condition vulnerability in Apache Tomcat. It allows remote code execution (RCE) on case-insensitive file systems when the default servlet is configured to permit write operations (a non-default setting). This flaw arises during JavaServer Pages (JSP) compilation, where an attacker can exploit the timing discrepancy between the security check and the file operation to execute arbitrary code. ([NVD](https://nvd.nist.gov/vuln/detail/CVE-2024-50379)) |
| **Affected Systems**        | - Apache Tomcat versions: <br>  - 11.0.0-M1 through 11.0.1 <br>  - 10.1.0-M1 through 10.1.33 <br>  - 9.0.0.M1 through 9.0.97 <br> - Systems running on case-insensitive file systems (e.g., Windows) with the default servlet's `readonly` initialization parameter set to `false`. |
| **Attack Vector**           | Remote: An attacker can exploit this vulnerability by uploading a JSP file to a vulnerable Tomcat server configured to allow write operations via the default servlet on a case-insensitive file system. |
| **Exploitation Techniques** | - **TOCTOU Race Condition**: The attacker exploits the time gap between the security check and the file operation during JSP compilation. <br> - **Case-Insensitive File Overwrite**: On case-insensitive file systems, filenames like `file.jsp` and `FILE.JSP` are considered identical. An attacker can upload a benign JSP file and then overwrite it with a malicious one using a differently cased filename, bypassing security checks. <br> - **Arbitrary Code Execution**: Once the malicious JSP file is in place, it can be executed by accessing it through the web server, leading to remote code execution. |
| **Proof of Concept (PoC)**  | A PoC demonstrating this vulnerability involves: <br> 1. **Uploading a Benign JSP File**: The attacker uploads a harmless JSP file (e.g., `file.jsp`) to the server. <br> 2. **Overwriting with Malicious JSP**: Leveraging the TOCTOU race condition, the attacker quickly uploads a malicious JSP file with a differently cased filename (e.g., `FILE.JSP`), causing the server to overwrite the original file without re-evaluating security permissions. <br> 3. **Executing Malicious Code**: The attacker accesses the malicious JSP file via the web server, triggering the execution of arbitrary code on the server. ([Medium Article](https://medium.com/@patelvidhi4288/deep-dive-poc-of-cve-2024-50379-exploit-tomcat-vulnerability-9-8-severity-776cfcfcf3ed)) |
| **The Impact of the Bug**   | - Unauthorized remote code execution on the server. <br> - Potential full system compromise, allowing attackers to manipulate server operations, access sensitive data, or deploy further malware. <br> - Elevated risk in environments where the default servlet is misconfigured to allow write operations on case-insensitive file systems. |
| **How to Detect Infections**| - **Log Analysis**: Review server logs for unusual file upload activities, especially multiple uploads with filenames differing only in case. <br> - **File Integrity Monitoring**: Implement monitoring to detect unexpected changes in JSP files, particularly those occurring in quick succession. <br> - **Configuration Audits**: Regularly audit server configurations to ensure the default servlet's `readonly` parameter is correctly set to prevent unauthorized write operations. |
| **Mitigation Steps**        | - **Update Apache Tomcat**: Upgrade to the fixed versions: <br>  - 11.0.2 <br>  - 10.1.34 <br>  - 9.0.98 <br> - **Configure Default Servlet**: Ensure the `readonly` initialization parameter of the default servlet is set to `true` to prevent write operations. <br> - **Deploy on Case-Sensitive File Systems**: If possible, use case-sensitive file systems to mitigate this class of vulnerabilities. <br> - **Implement Security Controls**: Restrict file upload capabilities to authenticated and authorized users, and validate uploaded files to prevent malicious content. |
| **Workarounds**             | - **Disable Write Access**: Configure the default servlet to disable write access by setting the `readonly` parameter to `true`. <br> - **Monitor File Uploads**: Implement monitoring mechanisms to detect and alert on suspicious file upload activities, especially those involving JSP files. |
| **References**              | - [NVD - CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379) <br> - [CVE - CVE-2024-50379](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-50379) <br> - [Medium Article - Deep Dive & POC of CVE-2024-50379](https://medium.com/@patelvidhi4288/deep-dive-poc-of-cve-2024-50379-exploit-tomcat-vulnerability-9-8-severity-776cfcfcf3ed) |
